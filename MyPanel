/**
 * Classe per gestire il panel che contiene tutti i componenti grafici fondamentali:
 * JTable(in uno JScrollPane), la JProgressBar, i pulsanti per interagire con i file e le JTextArea per 
 * inserire i dati necessari.
 * 
 * @author Alessandra
 */

package gui;
import logic.*;

import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.JTable;
import javax.swing.JLabel;
import javax.swing.JOptionPane;
import javax.swing.JTextField;
import javax.swing.ButtonGroup;
import javax.swing.JButton;
import javax.swing.JFileChooser;
import javax.swing.JRadioButton;
import javax.swing.JProgressBar;
import javax.swing.ListSelectionModel;
import javax.swing.table.DefaultTableModel;

import java.awt.event.*;
import java.io.File;
import java.util.Vector;


@SuppressWarnings("serial")
public class MyPanel extends JPanel implements ActionListener{
	private String path = "C:/Users/Lenovo/Desktop/Tutto/Università/Secondo Anno 19-20/Secondo Semestre/Calcolo Numerico/Appunti/";
	//private String path = "C:/Users/Lenovo/Desktop/Tutto/Vedere/MR.R0B07.S03E08/";
	private JTable table;
	private JLabel nomeFileInCorso, numeroFile;
	private JTextField t1, t2;
	private JButton b, b1, b2, b3, b4;
	private JRadioButton rb1, rb2, rb3, rb4;
	private ButtonGroup bg1, bg2;
	private JProgressBar progressBarTot;
	private Coda c;
	private Vector<String> colNames;
	private Vector<Vector<Object>> data;
	
	private String s= null;
	private char extra = 'd';
	
	DefaultTableModel MyModel;
	private JFileChooser fc;
	private File[] fs = null;
	
	/**
	 * Il costruttore chiama tutte le funzioni che inseriscono i componenti nel panel e inizializza il vettore data
	 *  e la coda per la JTable.
	 * 
	 * @author Alessandra
	 */
	
	public MyPanel() {
		super();
		super.paint(getGraphics());
		setLayout(null);
		setText();
		setButtons();
		data = new Vector<Vector<Object>>();
		setTable();	
		setProgressBar();
		setActions();
		c = new Coda();
	}
	
	/**
	 * La funzione setText() inserisce la scritta "Inserisci modifiche:", le due JTextArea in cui inserire 
	 * il numero di parti o di bytes in cui dividere il file e il vettore con i nomi delle colonne della JTable
	 */
	
	private void setText(){
		JLabel label = new JLabel("Inserisci modifiche:");
		label.setBounds(490, 180, 180, 20);
		add(label);
		
		t1 = new JTextField();
		t1.setEditable(false);
		t1.setBounds(575, 230, 100, 20);
		add(t1);
		t1.setColumns(10);
		
		t2 = new JTextField();
		t2.setEditable(false);
		t2.setBounds(575, 260, 100, 20);
		add(t2);
		t2.setColumns(10);
		
		nomeFileInCorso = new JLabel("");
		nomeFileInCorso.setBounds(480, 90, 200, 20);
		add(nomeFileInCorso);
		
		numeroFile = new JLabel("Numero file: 0");
		numeroFile.setBounds(480, 50, 200, 20);
		numeroFile.setVisible(true);
		add(numeroFile);
		
		colNames = new Vector<String>();
		colNames.add("File"); colNames.add("Operazione"); colNames.add("Info");	colNames.add("Extra");
	}
	
	/**
	 * La funzione setTable() implementa il MyModel derivante dal DefaultTableModel, così da poter usare i suoi Listener.
	 * Inoltre definisce lo JScrollPane, la modalità di selezione delle righe e la larghezza delle colonne.
	 */
	
	private void setTable(){
		MyModel = new DefaultTableModel(data, colNames){
			public boolean isCellEditable(int row, int column){
				return false;
			}
		};
		table = new JTable(MyModel);
		
		table.setRowSelectionAllowed(true);
		
		JScrollPane scrollPane = new JScrollPane();
		scrollPane.setBounds(30, 30, 420, 500);
		add(scrollPane);
		scrollPane.setViewportView(table);
		
		table.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);
				
		table.getColumnModel().getColumn(0).setPreferredWidth(200);
		table.getColumnModel().getColumn(1).setPreferredWidth(110);
		table.getColumnModel().getColumn(2).setPreferredWidth(50);
		table.getColumnModel().getColumn(3).setPreferredWidth(50);
	}
	
	/**
	 * La funzione setButtons() imposta locazione e dimensioni dei bottoni e li inserisce nel JPanel.
	 * Inoltre crea due ButtonGroup in cui inserire i JRadioButton così da poterne selezionare solo una funzione tra
	 * divisione in parti o file, e una soltanto (eventualmente) tra crittografia e compressione.
	 * Inizialmente le opzioni di crittografia e compressione non sono abilitati. 
	 */
	
	private void setButtons(){
		b = new JButton("OK"); 			b.setBounds(620, 180, 80, 20); add(b);
		b1 = new JButton("Aggiungi"); 	b1.setBounds(480, 441, 100, 30); add(b1);
		b2 = new JButton("Elimina"); 	b2.setBounds(600, 441, 100, 30); add(b2);
		b3 = new JButton("Merge"); 		b3.setBounds(480, 482, 100, 30); add(b3); 
		b4 = new JButton("Avvia"); 		b4.setBounds(600, 482, 100, 30); add(b4);
		
		bg1 = new ButtonGroup();
		bg2 = new ButtonGroup();
		
		rb1 = new JRadioButton("N° parti"); 	rb1.setBounds(490, 230, 80, 20); add(rb1);	
		rb2 = new JRadioButton("N° bytes"); 	rb2.setBounds(490, 260, 80, 20); add(rb2);
		rb3 = new JRadioButton("Crittografia"); rb3.setBounds(490, 290, 100, 20); add(rb3);
		rb4 = new JRadioButton("Compressione"); rb4.setBounds(490, 320, 120, 20); add(rb4);
		
		setEnabled(false);
		bg1.add(rb1); bg1.add(rb2); bg2.add(rb3); bg2.add(rb4); 
	}
	
	/**
	 * La funzione setActions aggiunge i ActionListener e i relativi ActionCommand ai bottoni del panel
	 */
	
	private void setActions(){
		b1.addActionListener(this); b1.setActionCommand("pb1");
		b2.addActionListener(this); b2.setActionCommand("pb2");
		b3.addActionListener(this); b3.setActionCommand("pb3");
		b4.addActionListener(this); b4.setActionCommand("pb4");
		b.addActionListener(this);  b.setActionCommand("pok");
				
		rb1.addActionListener(this); rb1.setActionCommand("prb1");
		rb2.addActionListener(this); rb2.setActionCommand("prb2");
		rb3.addActionListener(this); rb3.setActionCommand("prb3");
		rb4.addActionListener(this); rb4.setActionCommand("prb4");
	}
	
	private void setProgressBar(){		
		progressBarTot = new JProgressBar();
		progressBarTot.setBounds(470, 120, 250, 25);
		add(progressBarTot);
	}
	
/*		private void addProgressBarTot(){
		int v = progressBarTot.getValue();
		progressBarTot.setValue(v+1);
	}
	
	private void setInizio(int n){
		numeroFile.setText("Inizio la divisione, 0/" + n);
		progressBarTot.setMaximum(n);
	}
	
	private void avanzamento(String s, int n, int m){
		nomeFileInCorso.setText(s);
		addProgressBarTot();
		numeroFile.setText("Divisione file " + n + "/" + m);
	}
*/
	/**
	 * La funzione setVisibleText serve ad abilitare le TextArea delle funzioni selezionate e cancella il testo di quella 
	 * non attiva
	 * 
	 * @param a booleano per decidere se abilitare o meno la TextArea t1
	 * @param b booleano per decidere se abilitare o meno la TextArea t2
	 * @param c booleano per decidere se cancellaro o meno il testo della TextArea t1
	 * @param d booleano per decidere se cancellaro o meno il testo della TextArea t2
	 */
	
	private void setVisibleText(Boolean a, Boolean b, Boolean c, Boolean d){
		t1.setEditable(a);
		t2.setEditable(b);
		if (!c)
			t1.setText(null);
		if (!d)
			t2.setText(null);
	}
	
	/**
	 * La funzione setCZEnabled rende attivi o meno i bottoni di crittografia e compressione. È chiamata ogni volta che viene
	 * scelta una funzione tra divisione in parti e in bytes
	 * @param b booleano vero se sono selezionabili (divisione in bytes), falso altrimenti (divisione per parti)
	 */
	
	private void setCZEnabled(Boolean b){
		rb3.setEnabled(b); rb4.setEnabled(b); 
	}
	
	/**
	 * La funzione fileChooser() seleziona la cartella predefinita da cui far scegliere i file da modificare. 
	 * Se sono stati selezionati dei file, la lista di file viene salvata nell'array di File fs e passato alla coda per aggiungerli.
	 * Se non sono stati selezionati, svuota l'array di File fs.
	 */
	
	@SuppressWarnings("static-access")
	  private void fileChooser(){
	    fc = new JFileChooser(path);
	    fc.setMultiSelectionEnabled(true);
	    int n = fc.showOpenDialog(MyPanel.this); 
	    if (n==fc.APPROVE_OPTION){              
	      fs = fc.getSelectedFiles();
	      c.addFiles(fs);
	    }
	    else 
	      fs = null;
	    getFileNames();
	  }
	
	private void getFileNames(){
		if (c != null){
			for (int i=0 ; i < c.getSize() ; i++){
				System.out.print(c.getSize());
				System.out.println(" " + c.getNameFile(i));
			}
		}
		else
			System.out.println("niente zzì");
	}
	
	public void getElementiiii(){
		if (c!= null){
			System.out.println("MO COMINCIO");
			for (int i=0 ; i < c.getSize() ; i++){
				System.out.println(c.getNameFile(i) + " " + c.getOpIndex(i) + " " + c.getInfoIndex(i) + " " + c.getExtraIndex(i));
			}
		}
	}
	
	/**
	 * La funzione actionPerformed decide l'azione da svolgere a seconda del bottone che è stato premuto:
	 * 
	 * pb1 = bottone "aggiungi"
	 * 	Viene invocata la funzione fileChooser e creato un vettore di oggetti. In un ciclo for il vettore viene inizializzato
	 *  e gli vengono aggiunti il nome del file e gli altri campi sono aggiunti come default (null, null, 'd').
	 *  Questi vengono poi aggiunti al vettore data della tabella.
	 *  Poi viene usato il Listener del MyModel della modifica dei file e viene aggiornata la tabella.
	 *  
	 * pb2 = bottone "elimina"
	 *  Viene inizializzata una variabile intera i col valore della riga selezionata (getRowSelected())
	 *  Se il valore di i è valido (diverso da -1) viene eliminato sia nella coda che nel vettore data della tabella e si può
	 *  "avvertire" la tabella che i suoi dati sono stati modificati con il Listener del MyModel e aggiornarla.
	 *  Altrimenti compare un avviso per cui nessuna riga è selezionata
	 *  
	 * pb4 = bottone "start"
	 *  Viene creato un oggetto di tipo Splitter e si invoca la sua funzione per far avviare la divisione.
	 *  
	 * pok = bottone "ok"
	 *  Viene creata una variabile j che prende il valore di getRowSelected. Se è valida (ossia diversa da -1) e il valore
	 *  stringa è stato deciso (ossia è premuto uno dei bottoni principali "divisione per parti" o "divisione per bytes"),
	 *  a seconda del valore di questa viene salvato in una variabile intera n il valore numerioc della corrispondente JTextArea.
	 *  L'elemento i-esimo della coda viene quindi modificato con l'operazione inserita e l'eventuale crittografia o compressione,
	 *  il numero salvato in n e lasciando il file invariato.
	 *  Viene poi creato un Vector d il file corrispondente all'indice i, a cui vengono aggiunti i nuovi dati.
	 *  Questo viene poi sostituito al vecchio Vector di indice i nei data della tabella.
	 *  La tabella viene avvertita delle modifiche grazie al Listener del MyModel e quindi aggiornata.
	 *  
	 *  Vengono poi resettati i componenti per l'immissione dei dati: le stringhe delle JTextArea vengono cancellate e disabilitate,
	 *  con la funzione setVisibleArea(), tutti i pulsanti radio deselezionati, quelli crittografia e compressione disabilitati e 
	 *  il valore extra reimpostato a default.
	 *  
	 * prb1 = bottone radio "divisione per parti"
	 *  La stringa s è modificata in "#parti", la JTextArea t1 e abilitata alla modifica, la t2 no e il suo testo viene eliminato.
	 *  I bottoni di crittografia e compressione sono disabilitati.
	 *  
	 * prb2 = bottone radio "divisione per bytes"
	 *  La stringa s è modificata in "#bytes", la JTextArea t2 e abilitata alla modifica, la t1 no e il suo testo viene eliminato.
	 *  I bottoni di crittografia e compressione sono abilitati.
	 *   
	 * prb3 = bottone radio "crittografia"
	 *  Il carattere extra è modificato in 'c'
	 *  
	 * prb4 = bottone radio "compressione"
	 *  Il carattere extra è modificato in 'z'
	 */
	
	@Override
	public void actionPerformed(ActionEvent e) {
		switch(e.getActionCommand()){
			case "pb1": 
				fileChooser();
				Vector<Object> v;
				for(int i=0 ; i<fs.length ; i++){
					v = new Vector<Object>();
					v.add(fs[i].getName());
					v.add(null);
					v.add(null);
					v.add(extra);
					data.add(v);
				}
				numeroFile.setText("Numero file: " + c.getSize());
				MyModel.fireTableDataChanged();
				table.revalidate();
				break;
			case "pb2": 
				int i = table.getSelectedRow();
				if(i==-1) 
					JOptionPane.showInputDialog("NESSUNA RIGA SELEZIONATA");
				else{
					System.out.println(c.getNameFile(i) + " eliminato!");
					c.deleteIndex(i);
					data.remove(i);
					getFileNames();
					numeroFile.setText("Numero file: " + c.getSize());
					MyModel.fireTableDataChanged();
					table.revalidate();
				}
				break;
			case "pb3": 
				JOptionPane.showInputDialog("Ecco.. non possiamo riunire ancora ma grazie per aver considerato la nostra offerta!");
				break;
			case "pb4": 
				Splitter splitter = new Splitter(c);
				splitter.start();
				
				data = null;
				c = null;
				MyModel.fireTableDataChanged();
				table.revalidate();
				break;
				
			case "pok":
				int j = table.getSelectedRow();
				if (j!=-1){
					int n = 0;
					if(s == "")
						JOptionPane.showInputDialog("DATI INCOMPLETI");
					
					else {
						if(s == "#parti")
							n = Integer.parseInt(t1.getText());
						if(s == "#bytes")
							n = Integer.parseInt(t2.getText());
						c.setElementoIndex(j, c.getFileIndex(j), s, n, extra);
						Vector <Object> d = new Vector <Object>();
						d.add(c.getNameFile(j));d.add(c.getOpIndex(j));
						d.add(c.getInfoIndex(j));d.add(c.getExtraIndex(j));
						data.set(j, d);
						MyModel.fireTableDataChanged();
						table.revalidate();
						
						bg1.clearSelection(); bg2.clearSelection();
						extra = 'd';
						setVisibleText(false,false,false,false);
						setCZEnabled(false);
					}
				}
				else
					JOptionPane.showInputDialog("FILE NON SELEZIONATO");
				break;
			
			case "prb1":
				s = "#parti";
				setVisibleText(true,false,true,false);
				setCZEnabled(false);
				break;
			case "prb2":
				setVisibleText(false,true,false,true);
				setCZEnabled(true);
				s = "#bytes";
				break;
			case "prb3":
				extra = 'c';
				break;
			case "prb4":
				extra = 'z';
				break;
		}	
	}
	
	/**
	 * La funzione main crea un oggetto MyFrame, a cui viene aggiunto il MyPanel, e lo rende visibile.
	 * @param args
	 */
	
	public static void main(String[] args) {
		MyFrame f = new MyFrame("Progetto 2019/20 OOP");
		MyPanel p = new MyPanel();
		f.getContentPane().add(p);
		
		f.setVisible(true);
	}
}
